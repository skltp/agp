<?xml version="1.0" encoding="utf-8" standalone="no"?>
<mule
        xmlns="http://www.mulesoft.org/schema/mule/core"
        xmlns:http="http://www.mulesoft.org/schema/mule/http"
        xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
        xmlns:json="http://www.mulesoft.org/schema/mule/json"
        xmlns:mulexml="http://www.mulesoft.org/schema/mule/xml"
        xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting"
        xmlns:spring="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
	   http://www.springframework.org/schema/beans     http://www.springframework.org/schema/beans/spring-beans-current.xsd
	   http://www.mulesoft.org/schema/mule/core        http://www.mulesoft.org/schema/mule/core/current/mule.xsd
	   http://www.mulesoft.org/schema/mule/jms         http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd
	   http://www.mulesoft.org/schema/mule/json        http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
	   http://www.mulesoft.org/schema/mule/scripting   http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd
	   http://www.mulesoft.org/schema/mule/xml         http://www.mulesoft.org/schema/mule/xml/current/mule-xml.xsd
	   http://www.mulesoft.org/schema/mule/http        http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
	">


    <spring:bean scope="singleton"
                 id="takCacheBean"
                 class="se.skltp.agp.cache.TakCacheBean">
        <spring:property name="takEndpoint" value="${TAK_OUTBOUND_URL}" />
        <spring:property name="targetNamespace" value="${TAK_TJANSTEKONTRAKT}" />
        <spring:property name="serviceTimeout" value="${SERVICE_TIMEOUT_MS}" />
        <spring:property name="takLocalCacheFile" value="${TAK_CACHE_FILE_NAME}" />
    	<spring:property name="agpHsaId" value="${AGP_HSA_ID}"/>
    </spring:bean>

    <spring:bean name="takCache" class="se.skltp.takcache.TakCacheImpl">
        <spring:constructor-arg index="0" ref="takService"/>
    </spring:bean>

    <spring:bean name="hsaCache" class="se.skl.tp.hsa.cache.HsaCacheImpl"/>

    <spring:bean name="muleStartupNotification"
                 class="se.skltp.agp.cache.MuleStartupNotificationHandler">
        <spring:property name="takCache" ref="takCache"/>
        <spring:property name="hsaCache" ref="hsaCache"/>
        <spring:property name="hsaFiles" value="${HSA_FILES}"/>
        <spring:property name="tjanstekontrakt" value="${TAK_TJANSTEKONTRAKT}"/>
    </spring:bean>

    <!-- post to http://33.33.33.33:8084/tak/reset -->
    <!-- returns 'TAK cache for GetAggregatedVaccinationHistory-v2 has been reset' -->
    <flow name="reset-tak-cache-http-flow">
        <http:inbound-endpoint address="${TAK_INBOUND_RESET_CACHE_TAK_URL}"
                               connector-ref="soitoolkit-http-connector"
                               exchange-pattern="request-response"
                               responseTimeout="${SERVICE_TIMEOUT_MS}"
                               transformer-refs="logReqOut"
                               responseTransformer-refs="logRespIn" />

        <invoke object-ref="takCacheBean" method="updateCache" />

        <expression-transformer>
            <return-argument evaluator="string"
                             expression="TAK cache for ${APPLICATION_NAME} has been reset" />
        </expression-transformer>

    </flow>

</mule>